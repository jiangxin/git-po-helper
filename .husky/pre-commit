#!/usr/bin/env sh

# Pre-commit hook for git-po-helper
# This hook runs:
# 1. Go code formatting check (gofmt)
# 2. Lint check (go vet + staticcheck)
# 3. Unit tests

set -e

echo "ğŸ” Running pre-commit checks..."

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
  echo "âœ… No Go files staged, skipping Go checks"
  exit 0
fi

echo "ğŸ“ Checking Go code formatting..."

# Check if gofmt is available
if ! command -v gofmt >/dev/null 2>&1; then
  echo "âŒ Error: gofmt is not installed"
  exit 1
fi

# Check formatting for staged Go files
UNFORMATTED_FILES=$(echo "$STAGED_GO_FILES" | xargs gofmt -l 2>/dev/null || true)

if [ -n "$UNFORMATTED_FILES" ]; then
  echo "âŒ The following files are not properly formatted:"
  echo "$UNFORMATTED_FILES"
  echo ""
  echo "Please run 'gofmt -w' on these files or 'make fmt' if available"
  exit 1
fi

echo "âœ… All Go files are properly formatted"

echo "ğŸ” Running lint checks..."

# Run lint (go vet + staticcheck)
if ! make lint; then
  echo "âŒ Lint checks failed. Please fix the issues and try again."
  exit 1
fi

echo "âœ… Lint checks passed"

echo "ğŸ§ª Running unit tests..."

# Run unit tests
if ! make ut; then
  echo "âŒ Unit tests failed. Please fix the failing tests and try again."
  exit 1
fi

echo "âœ… All unit tests passed"

echo "âœ… All pre-commit checks passed!"
