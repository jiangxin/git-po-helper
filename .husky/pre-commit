#!/usr/bin/env sh

# Pre-commit hook for git-po-helper
# This hook runs:
# 1. Whitespace checks (trailing whitespace, missing EOL at EOF)
# 2. Go code formatting check (gofmt)
# 3. Lint check (go vet + staticcheck)
# 4. Unit tests

set -e

echo "ğŸ” Running pre-commit checks..."

# Get all staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No files staged, skipping checks"
  exit 0
fi

# Function to check if a file is a text file
is_text_file() {
  local file="$1"
  # Check if file exists in working tree
  if [ ! -f "$file" ]; then
    # File is new, check by extension or use git to check
    case "$file" in
      *.go|*.md|*.yaml|*.yml|*.sh|*.txt|*.json|*.toml|*.cfg|*.conf|*.ini|*.csv|*.po|*.pot|*.gitattributes|*.gitignore|Makefile|VERSION-GEN)
        return 0
        ;;
      *)
        # For other files, try to check if they're binary
        # If file doesn't exist yet, we can't check, so assume text for common extensions
        return 0
        ;;
    esac
  else
    # File exists, use file command if available, otherwise check extension
    if command -v file >/dev/null 2>&1; then
      file_output=$(file -b --mime-type "$file" 2>/dev/null || echo "unknown")
      case "$file_output" in
        text/*|application/json|application/xml|application/yaml)
          return 0
          ;;
        *)
          return 1
          ;;
      esac
    else
      # Fallback: check extension
      case "$file" in
        *.go|*.md|*.yaml|*.yml|*.sh|*.txt|*.json|*.toml|*.cfg|*.conf|*.ini|*.csv|*.po|*.pot|*.gitattributes|*.gitignore|Makefile|VERSION-GEN)
          return 0
          ;;
        *)
          # Exclude common binary extensions
          case "$file" in
            *.png|*.jpg|*.jpeg|*.gif|*.ico|*.svg|*.pdf|*.zip|*.tar|*.gz|*.exe|*.bin|*.so|*.dylib|*.dll)
              return 1
              ;;
            *)
              # Default to text for unknown types
              return 0
              ;;
          esac
          ;;
      esac
    fi
  fi
}

# Filter text files from staged files
STAGED_TEXT_FILES=""
for file in $STAGED_FILES; do
  if is_text_file "$file"; then
    STAGED_TEXT_FILES="$STAGED_TEXT_FILES $file"
  fi
done

# Trim leading space
STAGED_TEXT_FILES=$(echo "$STAGED_TEXT_FILES" | sed 's/^[[:space:]]*//')

# Check whitespace issues using git diff --check
echo "ğŸ” Checking whitespace issues (trailing whitespace, missing EOL at EOF)..."

if [ -n "$STAGED_TEXT_FILES" ]; then
  # Use git diff --check to detect whitespace issues
  # This checks for trailing whitespace and missing newline at EOF
  # git diff --check exits with non-zero if issues are found
  set +e  # Temporarily disable exit on error to capture output
  WHITESPACE_ISSUES=$(git diff --cached --check 2>&1)
  CHECK_EXIT_CODE=$?
  set -e  # Re-enable exit on error

  if [ $CHECK_EXIT_CODE -ne 0 ]; then
    echo "âŒ Whitespace issues detected:"
    echo "$WHITESPACE_ISSUES"
    echo ""
    echo "Please fix the following issues:"
    echo "  - Remove trailing whitespace at end of lines"
    echo "  - Ensure files end with a newline character"
    echo ""
    echo "You can use the following commands to fix:"
    echo "  git diff --check                    # Review issues"
    echo "  sed -i '' 's/[[:space:]]*$//' FILE  # Remove trailing whitespace (macOS)"
    echo "  sed -i 's/[[:space:]]*$//' FILE     # Remove trailing whitespace (Linux)"
    echo ""
    echo "Or use your editor to fix the issues manually."
    exit 1
  fi
fi

echo "âœ… No whitespace issues found"

# Get list of staged Go files
STAGED_GO_FILES=$(echo "$STAGED_FILES" | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
  echo "âœ… No Go files staged, skipping Go-specific checks"
  echo "âœ… All pre-commit checks passed!"
  exit 0
fi

echo "ğŸ“ Checking Go code formatting..."

# Check if gofmt is available
if ! command -v gofmt >/dev/null 2>&1; then
  echo "âŒ Error: gofmt is not installed"
  exit 1
fi

# Check formatting for staged Go files
UNFORMATTED_FILES=$(echo "$STAGED_GO_FILES" | xargs gofmt -l 2>/dev/null || true)

if [ -n "$UNFORMATTED_FILES" ]; then
  echo "âŒ The following files are not properly formatted:"
  echo "$UNFORMATTED_FILES"
  echo ""
  echo "Please run 'gofmt -w' on these files or 'make fmt' if available"
  exit 1
fi

echo "âœ… All Go files are properly formatted"

echo "ğŸ” Running lint checks..."

# Run lint (go vet + staticcheck)
if ! make lint; then
  echo "âŒ Lint checks failed. Please fix the issues and try again."
  exit 1
fi

echo "âœ… Lint checks passed"

echo "ğŸ§ª Running unit tests..."

# Run unit tests
if ! make ut; then
  echo "âŒ Unit tests failed. Please fix the failing tests and try again."
  exit 1
fi

echo "âœ… All unit tests passed"

echo "âœ… All pre-commit checks passed!"
